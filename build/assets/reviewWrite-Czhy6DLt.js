import{m as I,a as b,g as l,h as E,s as w,f as L,d as $}from"./footer-CGVTRZKF.js";import{c as C}from"./cart-service-CmqApfUf.js";const N=I({showCart:!0,currentNav:"review"});b();const g=document.getElementById("reviewWriteForm"),U=document.getElementById("reviewProductSelect"),s=document.getElementById("reviewImagesInput"),i=document.getElementById("reviewImagePreview"),h=document.getElementById("reviewImageCount"),S=Number(new URLSearchParams(location.search).get("productId")),c=3;let r=[],u=[];async function P(){const e=await w()||l();let t=0;try{t=await C()}catch{t=0}$(N,{userName:e?.name||e?.email||null,cartCountValue:t})}function v(){u.forEach(e=>URL.revokeObjectURL(e)),u=[]}function R(){h&&(h.textContent=`${r.length}/${c}`)}function y(){if(typeof DataTransfer>"u")return;const e=new DataTransfer;r.forEach(t=>e.items.add(t));try{s.files=e.files}catch{}}function m(){if(v(),R(),!r.length){i.innerHTML='<p class="review-image-empty">선택된 이미지가 없습니다.</p>';return}i.innerHTML=r.map((e,t)=>{const n=URL.createObjectURL(e);return u.push(n),`
        <figure class="review-image-item">
          <img src="${n}" alt="리뷰 이미지 ${t+1}" />
          <button type="button" class="review-image-remove" data-action="removeImage" data-index="${t}" aria-label="이미지 삭제">×</button>
        </figure>
      `}).join("")}function p(e){return`${e.name}-${e.size}-${e.lastModified}`}function T(e){if(!e.length)return;const t=new Set(r.map(p));let n=0,a=0;e.forEach(d=>{const f=p(d);if(t.has(f)){n+=1;return}if(r.length>=c){a+=1;return}r.push(d),t.add(f)});const o=[];a>0&&o.push(`이미지는 최대 ${c}장까지 첨부할 수 있습니다.`),n>0&&o.push("동일한 이미지는 한 번만 첨부됩니다."),o.length&&alert(o.join(`
`)),y(),m()}s.addEventListener("change",()=>{T([...s.files]),s.value=""});i.addEventListener("click",e=>{const t=e.target.closest("[data-action='removeImage']");if(!t)return;const n=Number(t.dataset.index);Number.isNaN(n)||n<0||n>=r.length||(r.splice(n,1),y(),m())});window.addEventListener("beforeunload",v);g.addEventListener("submit",async e=>{if(e.preventDefault(),!l()){alert("리뷰 작성은 로그인 후 가능합니다."),location.href="/pages/login.html";return}const n=Object.fromEntries(new FormData(g).entries()),a=[...r];try{await E({productId:Number(n.productId),score:Number(n.score),title:n.title,content:n.content,images:a}),alert("리뷰가 등록되었습니다."),location.href="/pages/reviews.html"}catch(o){if(console.error(o),o.status===401){alert("로그인이 만료되었습니다. 다시 로그인해주세요."),location.href="/pages/login.html";return}alert(o.message||"리뷰 등록에 실패했습니다.")}});(async function(){try{if(!(await w()||l())){alert("리뷰 작성은 로그인 후 가능합니다."),location.href="/pages/login.html";return}const n=await L();U.innerHTML=n.map(a=>`<option value="${a.id}" ${a.id===S?"selected":""}>${a.name}</option>`).join(""),m(),await P()}catch(t){console.error(t),alert("리뷰 작성 페이지 초기화에 실패했습니다.")}})();
