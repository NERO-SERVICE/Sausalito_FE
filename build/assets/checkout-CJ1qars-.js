import{m as h,a as y,s as g,g as f,o as b,p as N,q as A,j as w,d as k}from"./footer-CX_4Vxnh.js";import{f as B,c as I}from"./cart-service-BJL0NQK-.js";import{a as v,f as d}from"./store-data-Deux6dsM.js";const E=h({showCart:!0,currentNav:"shop"});y();const m=new URLSearchParams(location.search),l={bank_name:"신한은행",bank_account_no:"110-555-012345",account_holder:"소살리토",guide_message:"입금 후 관리자 확인이 완료되면 결제완료 처리됩니다."},t={user:null,mode:"cart",method:"NAVERPAY",loading:!1,buyNow:{productId:Number(m.get("productId")||0),optionId:Number(m.get("optionId")||0)||null,quantity:Math.max(1,Number(m.get("quantity")||1))},summary:{items:[],subtotal:0,shipping:0,total:0},bankAccount:l},n={form:document.getElementById("checkoutForm"),summary:document.getElementById("checkoutSummary"),submitBtn:document.getElementById("checkoutSubmitBtn"),methodButtons:Array.from(document.querySelectorAll("[data-method]")),methodPanels:Array.from(document.querySelectorAll("[data-method-panel]")),bankAccount:document.getElementById("checkoutBankAccount"),recipient:document.getElementById("checkoutRecipient"),phone:document.getElementById("checkoutPhone"),postalCode:document.getElementById("checkoutPostalCode"),roadAddress:document.getElementById("checkoutRoadAddress"),jibunAddress:document.getElementById("checkoutJibunAddress"),detailAddress:document.getElementById("checkoutDetailAddress"),depositorName:document.getElementById("checkoutDepositorName"),depositorPhone:document.getElementById("checkoutDepositorPhone"),transferNote:document.getElementById("checkoutTransferNote")};function s(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function P(e){return e>=5e4?0:3e3}function S(e,o,a){const u=Number(o?.price??e?.price??0),r=u*a,c=r,i=P(c);return{items:[{productId:e.id,optionId:o?.id||null,name:e.name||"상품",optionName:o?.name||"",quantity:a,unitPrice:u,lineTotal:r,image:e.image||""}],subtotal:c,shipping:i,total:c+i}}function C(e){return{items:Array.isArray(e.items)?e.items.map(a=>({productId:a.product?.id||0,optionId:a.option?.id||null,name:a.product?.name||"상품",optionName:a.option?.name||"",quantity:Number(a.quantity||0),unitPrice:Number(a.option?.price!==void 0&&a.option?.price!==null?a.option.price:a.product?.price||0),lineTotal:Number(a.lineTotal||0),image:a.product?.image||""})):[],subtotal:Number(e.subtotal||0),shipping:Number(e.shipping||0),total:Number(e.total||0)}}function $(){const e=t.summary.items.map(o=>`
      <article class="checkout-item">
        <img src="${s(v(o.image))}" alt="${s(o.name)}" />
        <div>
          <strong>${s(o.name)}</strong>
          <p>${o.optionName?`${s(o.optionName)} / `:""}${o.quantity}개</p>
        </div>
        <b>${d(o.lineTotal)}</b>
      </article>
    `).join("");n.summary.innerHTML=`
    <section class="checkout-summary-card">
      <h4>주문 상품</h4>
      <div class="checkout-item-list">
        ${e||'<p class="empty">주문 상품이 없습니다.</p>'}
      </div>
      <div class="checkout-total-box">
        <p><span>상품금액</span><strong>${d(t.summary.subtotal)}</strong></p>
        <p><span>배송비</span><strong>${d(t.summary.shipping)}</strong></p>
        <p class="final"><span>총 결제금액</span><strong>${d(t.summary.total)}</strong></p>
      </div>
    </section>
  `}function T(){const e=t.bankAccount||l;n.bankAccount.innerHTML=`
    <strong>입금 계좌</strong>
    <p>${s(e.bank_name)} ${s(e.bank_account_no)}</p>
    <small>예금주 ${s(e.account_holder)}</small>
    <small>${s(e.guide_message||l.guide_message)}</small>
  `}function p(){if(n.methodButtons.forEach(e=>{const o=e.dataset.method===t.method;e.classList.toggle("is-active",o),e.setAttribute("aria-pressed",String(o))}),n.methodPanels.forEach(e=>{const o=e.dataset.methodPanel===t.method;e.classList.toggle("is-active",o),e.hidden=!o}),t.loading){n.submitBtn.textContent="처리 중...",n.submitBtn.disabled=!0;return}t.method==="NAVERPAY"?n.submitBtn.textContent="네이버페이 결제하기":t.method==="TRANSFER"?n.submitBtn.textContent="계좌이체 결제하기":n.submitBtn.textContent="무통장입금 접수하기",n.submitBtn.disabled=!1}function _(){return{recipient:n.recipient.value.trim(),phone:n.phone.value.trim(),postalCode:n.postalCode.value.trim(),roadAddress:n.roadAddress.value.trim(),jibunAddress:n.jibunAddress.value.trim(),detailAddress:n.detailAddress.value.trim()}}function R(e){if(!e.recipient||!e.phone||!e.postalCode||!e.roadAddress)throw new Error("받는 분/연락처/우편번호/도로명 주소는 필수입니다.")}function q(){n.recipient.value=t.user?.name||"",n.phone.value=t.user?.phone||"",n.postalCode.value="04524",n.roadAddress.value="서울특별시 중구 세종대로 110",n.jibunAddress.value="",n.detailAddress.value="",n.depositorName.value=t.user?.name||"",n.depositorPhone.value=t.user?.phone||""}async function L(){let e=0;try{e=await I()}catch{e=0}k(E,{userName:t.user?.name||t.user?.email||null,isAdmin:!!(t.user?.is_staff??t.user?.isStaff),cartCountValue:e})}async function j(){if(m.get("buyNow")==="1"&&t.buyNow.productId>0){t.mode="buyNow";const a=await w(t.buyNow.productId);if(!a)throw new Error("상품 정보를 찾을 수 없습니다.");const u=t.buyNow.optionId&&(a.options||[]).find(r=>Number(r.id)===Number(t.buyNow.optionId))||null;t.summary=S(a,u,t.buyNow.quantity);return}t.mode="cart";const o=await B();if(!o.items.length)throw new Error("장바구니가 비어 있습니다.");t.summary=C(o)}async function H(){const e=_();R(e);const o=n.depositorName.value.trim(),a=n.depositorPhone.value.trim(),u=n.transferNote.value.trim();if(!o)throw new Error("무통장입금의 입금자명을 입력해주세요.");const r={...e};t.mode==="buyNow"&&(r.buyNowProductId=t.buyNow.productId,r.buyNowQuantity=t.buyNow.quantity,t.buyNow.optionId&&(r.buyNowOptionId=t.buyNow.optionId));const c=await N(r),i=await A({orderNo:c.orderNo,depositorName:o,depositorPhone:a,transferNote:u});alert(["무통장입금 요청이 접수되었습니다.",`주문번호: ${i.orderNo}`,`입금계좌: ${i.bankName} ${i.bankAccountNo} (${i.accountHolder})`,"입금 확인 후 결제완료 처리됩니다."].join(`
`)),location.href="/pages/mypage.html?tab=orders"}n.methodButtons.forEach(e=>{e.addEventListener("click",()=>{if(t.loading)return;const o=e.dataset.method;o&&(t.method=o,p())})});n.form?.addEventListener("submit",async e=>{if(e.preventDefault(),!t.loading)try{if(t.method==="NAVERPAY"){alert("네이버페이 간편결제는 현재 준비 중입니다.");return}if(t.method==="TRANSFER"){alert("계좌이체 결제는 현재 준비 중입니다.");return}t.loading=!0,p(),await H()}catch(o){console.error(o),alert(o.message||"결제 처리에 실패했습니다.")}finally{t.loading=!1,p()}});(async function(){const o=await g()||f();if(!o){alert("주문/결제는 로그인 후 이용 가능합니다."),location.href="/pages/login.html";return}t.user=o,q();try{await j();try{t.bankAccount=await b()}catch{t.bankAccount=l}$(),T(),p(),await L()}catch(a){console.error(a),alert(a.message||"주문서 데이터를 불러오지 못했습니다."),location.href="/pages/cart.html"}})();
